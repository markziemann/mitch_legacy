---
title: "nDrichr Report"
author: "Antony Kaspi & Mark Ziemann"
runtime: shiny
output: html_document
theme: cosmo
---

```{r,,results="asis",echo=FALSE}
date()
```

## Background

nDrich performs multidimensional gene set enrichment analysis. The concept behind this dates to work by Cox and 
Mann (https://doi.org/10.1186/1471-2105-13-S16-S12). This implementation is suited to R based workflows of 
multi-omics datasets. This software was developed by Antony Kaspi and Mark Ziemann.

## Input profiles

Here is the first few lines of the input profile.

```{r,echo=FALSE}
load(DATANAME)
head(x)
```

Here are some metrics about the input data profile:

```{r,echo=FALSE}
  unformatted<-t(as.data.frame(res$manova_analysis_metrics[ c(2,3,4,5,11,12 ) ])) 
  formatted<-unformatted
  formatted[1:4]<-as.character(round(as.numeric(unformatted[1:4]) , digits=0))
  formatted[5:6]<-as.character(round(as.numeric(unformatted[5:6]) , digits=5))
  colnames(formatted)="Profile metrics"
  kable( formatted, caption = "Profile metrics" )

```

Here we look at the dynamic range of differential signal in the two contrasts.

```{r,echo=FALSE,fig.height = 6, fig.width = 6.5}
  library(vioplot)
  vioplot(res$input_profile[,1],res$input_profile[,2],col="gray",names=colnames(res$input_profile))
  title("Dynamic range of signal",ylab="signal", xlab="contrast")

```

Here is the contour plot of the profile including all genes.

```{r,echo=FALSE,fig.height = 6, fig.width = 6.5}
  palette <- colorRampPalette(c("white", "yellow","orange" ,"red","darkred","black"))

  #Contour of all the data
  ss<-res$ranked_profile

  xmin=min(ss[,1])
  xmax=max(ss[,1])
  ymin=min(ss[,2])
  ymax=max(ss[,2])

  k<-MASS:::kde2d(ss[,1],ss[,2])
  X_AXIS=paste("Rank in contrast",colnames(ss)[1])
  Y_AXIS=paste("Rank in contrast",colnames(ss)[2])
  filled.contour(k, xlim=c(xmin,xmax),ylim=c(ymin,ymax),
    color=palette ,
    plot.title={ abline(v=0,h=0,lty=2,lwd=2,col="blue")
       title( main="Rank-rank plot of all genes",xlab=X_AXIS,ylab=Y_AXIS )
    }
  )

```

Here is the distribution of genes in the four quadrants

```{r,results="asis",echo=FALSE}
 uu=length(which(res$input_profile[,1]>0 & res$input_profile[,2]>0))
 ud=length(which(res$input_profile[,1]>0 & res$input_profile[,2]<0))
 dd=length(which(res$input_profile[,1]<0 & res$input_profile[,2]<0))
 du=length(which(res$input_profile[,1]<0 & res$input_profile[,2]>0))
 a<-as.data.frame(c(uu,ud,dd,du))
 rownames(a)=c("top-right","bottom-right","bottom-left","top-left")
 colnames(a)="a"
 barplot(a$a,names.arg=rownames(a),main="number of genes in each quadrant")
```



## Input genesets
Here are some metrics about the gene sets used:

```{r,results="asis",echo=FALSE}
  unformatted<-t(as.data.frame(res$manova_analysis_metrics[ c(1,6,7,13,14  ) ]))
  formatted<-as.data.frame(as.character( unformatted[1:5]) )
  rownames(formatted)=rownames(unformatted)
  colnames(formatted)="Gene sets metrics"
  kable( formatted , col.names = "Gene sets metrics" ,caption = "Gene sets metrics" )
```

Quadrant order is top-right, bottom-right, bottom-left and top-left.

```{r,results="asis",echo=FALSE}
 a<-res$manova_analysis_metrics[14]
 a<-as.data.frame(as.numeric(unlist(strsplit(as.character(a),','))),stringsAsFactors=F)
 rownames(a)=c("top-right","bottom-right","bottom-left","top-left")
 colnames(a)="a"
 barplot(a$a,names.arg=rownames(a),main="number of genesets FDR<0.05")
```

More about the sizes of the gene sets evaluated.

```{r,results="asis",echo=FALSE,fig.height = 10, fig.width = 7}
  par(mfrow=c(3,1))
  geneset_counts<-res$manova_analysis_metrics$geneset_counts
  boxplot(geneset_counts[,2],horizontal=T,frame=F,main="Gene set size",xlab="number of member genes included in profile")
  hist(geneset_counts$count,100,xlab="geneset size",main="Histogram of geneset size")
  hist(geneset_counts$count,100,xlim=c(0,500),xlab="geneset size",main="Trimmed histogram of geneset size")

```

## Enrichment scatterplot with taucharts

All sets with p.adjustMANOVA<0.05. Try hovering over the points.

```{r,results="asis",echo=F, fig.height = 7, fig.width = 7}
library("taucharts")
library(dplyr)
  numsets=nrow(subset(res$manova_result,p.adjustMANOVA<0.05))
  if (numsets>10){
    print("showing significant sets with p.adjust MANOVA<0.05") 
    myres<-subset(res$manova_result,p.adjustMANOVA<0.05)
  } else {
    message("No significant enrichments found, but here are the top results anyway")
    myres<-head(res$manova_result,20)
  }

  myres$p.adjustMANOVA<-signif(myres$p.adjustMANOVA,3)
  myres<-myres[,c(1,8,2,4,5)]
  myres$set<-gsub("_"," ",as.character(myres$set))
  colnames(myres)=gsub("\\.","_",colnames(myres))
  my_x=colnames(myres)[4]
  my_y=colnames(myres)[5]

#mylink="<a href='www.dee2.io'>link</a>"
#myres$link<-mylink

  tauchart(myres) %>% 
    tau_point(my_x,my_y) %>% 
    tau_tooltip()
 
```

## Results table

```{r,results="hide",echo=FALSE}
#https://stackoverflow.com/questions/39362183/how-can-i-embed-a-plot-within-a-rmarkdown-table
```

```{r,results="asis",echo=FALSE}
  numsets=nrow(subset(res$manova_result,p.adjustMANOVA<0.05))
  if (numsets>10){
    print("showing significant sets with p.adjust MANOVA<0.05")
    myres<-subset(res$manova_result,p.adjustMANOVA<0.05)
    if ( nrow(myres)>100 ) { myres<-myres[1:100,] }

  } else {
    message("No significant enrichments found, but here are the top results anyway")
    myres<-head(res$manova_result,20)
  }

  myres<-myres[,c(1:3,8,4:7)]
  myres<-head(myres,n=10L)
  formatted<-myres
  formatted[,1]<-gsub("_"," ",myres[,1])
  formatted[,3:8]<-format(myres[,3:8],digits=3)
  kable( formatted , col.names = colnames(myres) , row.names=F, caption = "Top 100 gene sets" ,digits=100) 
```

## Detailed Gene set reports 1

```{r,results="asis",echo=FALSE,fig.height=5, fig.width=6,out.width = '40%',comment=NA}

 numsets=nrow(subset(res$manova_result,p.adjustMANOVA<0.05))
  if (numsets>10){
    print("showing significant sets with p.adjust MANOVA<0.05")
    myres<-subset(res$manova_result,p.adjustMANOVA<0.05)
    if ( nrow(myres)>100 ) { myres<-myres[1:100,] }
  } else {
    message("No significant enrichments found, but here are the top results anyway")
    myres<-head(res$manova_result,20)
  }


for ( s in 1:10 ) {
  myset=gsub("_"," ",as.character(myres[s,1]))
  mysize=as.character(myres[s,2])
  mypadjmanova=as.character(signif(myres[s,8],3))
  mysx=as.character(signif(myres[s,4],3))
  mysy=as.character(signif(myres[s,5],3))
  mypx=as.character(signif(myres[s,6],3))
  mypy=as.character(signif(myres[s,7],3))
  mydetails<-as.data.frame(c(mysize,mysx,mysy,mypx,mypy,mypadjmanova))
  mydetails$names<-c("SetSize","x-axis enrichment score","y-axis enrichment score","nom p-value for x-axis enrichment",
    "nom p-value for y-axis enrichment","FDR MANOVA")
  mydetails<-mydetails[,c(2,1)]
  print(kable( mydetails , format="html" , col.names = c(myset,"Value") ,digits=5 ) )

  mysx=signif(myres[s,4],3)
  mysy=signif(myres[s,5],3)

  i=s
  ll<-res$manova_result[i,]
  size<-ll$setSize
  sss<-as.data.frame(ss[rownames(ss) %in% res$input_genesets[res$input_genesets[,1]== ll$set,2],])
  k<-MASS:::kde2d(sss[,1],sss[,2])

  par(mai=c(1.02,0.82,0.82,0.42))
  filled.contour( k, color = palette, xlim=c(xmin,xmax),ylim=c(ymin,ymax),
      plot.title={ abline(v=0,h=0,lty=2,lwd=2,col="blue")
      title( main=paste(ll$set,"\n(",size,")",ll$variable,format(ll$value,digits=3)),
        xlab=X_AXIS,ylab=Y_AXIS
      )
    }
  )

  par(mai=c(1.02,0.82,0.82,1.42))
  plot(sss, pch=19, col=rgb(red = 0, green = 0, blue = 0, alpha = 0.2),
    main=paste(ll$set,"\n(",size,")",ll$variable,format(ll$value,digits=3)),
    xlim=c(xmin,xmax),ylim=c(ymin,ymax),
    xlab=X_AXIS,ylab=Y_AXIS
  )
  abline(v=0,h=0,lty=2,lwd=2,col="blue")

  tl=bl=tr=br=0
  if ( mysy>0 ) { tl=tl+1 ; tr=tr+1  } else { bl=bl+1 ; br=br+1 }
  if ( mysx>0 ) { tr=tr+1 ; br=br+1  } else { tl=tl+1 ; bl=bl+1 }

  if (bl==2) {
    myquad<-sss[which(sss[,1]<0 & sss[,2]<0),]
    topgenes<-myquad[order(-rank(myquad[,1]*myquad[,2])),]
  }

  if (tr==2) {
    myquad<-sss[which(sss[,1]>0 & sss[,2]>0),]
    topgenes<-myquad[order(-rank(myquad[,1]*myquad[,2])),]
  }

  if (br==2) {
    myquad<-sss[which(sss[,1]>0 & sss[,2]<0),]
    topgenes<-myquad[order(rank(myquad[,1]*myquad[,2])),]
  }

  if (tl==2) {
    myquad<-sss[which(sss[,1]<0 & sss[,2]>0),]
    topgenes<-myquad[order(rank(myquad[,1]*myquad[,2])),]
  }
  print("<br>")
  topgenes$Gene<-rownames(topgenes)
  topgenes<-topgenes[,c(3,1,2)]
  print(kable( head(topgenes,n=20L) , col.names = colnames(topgenes) , format="html",row.names=F, caption = "Top 20 genes" ,digits=100))


  cat("<br><hr>")
}
```

## Detailed Gene set reports 2

```{r,results="asis",echo=FALSE,fig.height=5, fig.width=6,out.width = '40%',comment=NA}
 numsets=nrow(subset(res$manova_result,p.adjustMANOVA<0.05))
  if (numsets>10){
    print("showing significant sets with p.adjust MANOVA<0.05")
    myres<-subset(res$manova_result,p.adjustMANOVA<0.05)
    if ( nrow(myres)>100 ) { myres<-myres[1:100,] }
  } else {
    message("No significant enrichments found, but here are the top results anyway")
    myres<-head(res$manova_result,20)
  }

for ( s in 1:10 ) {
  myset=gsub("_"," ",as.character(myres[s,1]))
  mysize=myres[s,2]
  mypadjmanova=signif(myres[s,8],3)
  mysx=signif(myres[s,4],3)
  mysy=signif(myres[s,5],3)
  mypx=signif(myres[s,6],3)
  mypy=signif(myres[s,7],3)
  HEADER=paste("\'<details><summary><b>",myset,"</b></summary>",sep=" " )
  DETAILS=paste("<p> GeneSet:",myset,
    "<br> SetSize:",mysize,
    "<br> x-axis enrichment score:",mysx,
    "<br> y-axis enrichment score:",mysy,
    "<br> nom p-value for x-axis enrichment:",mypx,
    "<br> nom p-value for y-axis enrichment:",mypy,
    "<br> FDR MANOVA:",mypadjmanova,
    "</p> ")
  print(paste(HEADER,DETAILS),quote=F)

  i=s
  ll<-res$manova_result[i,]
  size<-ll$setSize
  sss<-as.data.frame(ss[rownames(ss) %in% res$input_genesets[res$input_genesets[,1]== ll$set,2],])
  k<-MASS:::kde2d(sss[,1],sss[,2])

  par(mai=c(1.02,0.82,0.82,0.42))
  filled.contour( k, color = palette, xlim=c(xmin,xmax),ylim=c(ymin,ymax),
      plot.title={ abline(v=0,h=0,lty=2,lwd=2,col="blue")
      title( main=paste(ll$set,"\n(",size,")",ll$variable,format(ll$value,digits=3)),
        xlab=X_AXIS,ylab=Y_AXIS
      )
    }
  )

  par(mai=c(1.02,0.82,0.82,1.42))
  plot(sss, pch=19, col=rgb(red = 0, green = 0, blue = 0, alpha = 0.2),
    xlim=c(xmin,xmax),ylim=c(ymin,ymax),
    main=paste(ll$set,"\n(",size,")",ll$variable,format(ll$value,digits=3)),
    xlab=X_AXIS,ylab=Y_AXIS
  )
  abline(v=0,h=0,lty=2,lwd=2,col="blue")

  tl=bl=tr=br=0
  if ( mysy>0 ) { tl=tl+1 ; tr=tr+1  } else { bl=bl+1 ; br=br+1 } 
  if ( mysx>0 ) { tr=tr+1 ; br=br+1  } else { tl=tl+1 ; bl=bl+1 } 

  if (bl==2) {
    myquad<-sss[which(sss[,1]<0 & sss[,2]<0),]
    topgenes<-head(myquad[order(-rank(myquad[,1]*myquad[,2])),],n=50)
  }

  if (tr==2) {
    myquad<-sss[which(sss[,1]>0 & sss[,2]>0),]
    topgenes<-head(myquad[order(-rank(myquad[,1]*myquad[,2])),],n=50)
  }

  if (br==2) {
    myquad<-sss[which(sss[,1]>0 & sss[,2]<0),]
    topgenes<-head(myquad[order(rank(myquad[,1]*myquad[,2])),],n=50)
  }

  if (tl==2) {
    myquad<-sss[which(sss[,1]<0 & sss[,2]>0),]
    topgenes<-head(myquad[order(rank(myquad[,1]*myquad[,2])),],n=50)
  }
  print("<br>")
  topgenes$Gene<-rownames(topgenes)
  topgenes<-topgenes[,c(3,1,2)]
  print(kable( head(topgenes,n=20L) , col.names = colnames(topgenes) , format="html",row.names=F, caption = "Top 20 genes" ,digits=100))

  print("</details>\'")

}
```


